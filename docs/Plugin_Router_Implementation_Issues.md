# Nekro Agent æ’ä»¶è·¯ç”±å®ç°é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜ç°è±¡
- âœ… æ’ä»¶è·¯ç”±åœ¨ OpenAPI æ–‡æ¡£ä¸­æ­£ç¡®æ˜¾ç¤º
- âœ… è·¯ç”±ç®¡ç†å™¨æ˜¾ç¤ºè·¯ç”±å·²æˆåŠŸæŒ‚è½½ 
- âœ… åº”ç”¨è·¯ç”±æ€»æ•°æ­£ç¡®å¢åŠ ï¼ˆ127 â†’ 135ï¼‰
- âŒ è®¿é—®æ’ä»¶è·¯ç”±è¿”å› 404 Not Found

### å…³é”®å‘ç°

#### FastAPI åŠ¨æ€è·¯ç”±æœºåˆ¶çš„æ ¸å¿ƒçŸ¥è¯† [[memory:2830793]]

1. **Mount vs include_router çš„æœ¬è´¨åŒºåˆ«**ï¼š
   - `Mount` ç”¨äºæŒ‚è½½æ•´ä¸ª FastAPI å­åº”ç”¨ï¼Œå‚æ•°å¿…é¡»æ˜¯ `FastAPI` å®ä¾‹
   - `include_router` ç”¨äºæŒ‚è½½ `APIRouter`ï¼Œè¿™æ˜¯æ­£ç¡®çš„æ–¹å¼

2. **include_router çš„è®¾è®¡é™åˆ¶**ï¼š
   - é€šè¿‡ `include_router` æ·»åŠ çš„è·¯ç”±ä¼šè¢«ç›´æ¥åˆå¹¶åˆ°ä¸»åº”ç”¨çš„è·¯ç”±è¡¨ä¸­
   - è¿™äº›è·¯ç”±**æ— æ³•åœ¨è¿è¡Œæ—¶åŠ¨æ€ç§»é™¤**ï¼Œè¿™æ˜¯ FastAPI çš„è®¾è®¡é™åˆ¶
   - é‡å¤è°ƒç”¨ `include_router` ä¼šå¯¼è‡´è·¯ç”±é‡å¤

3. **OpenAPI æ–‡æ¡£åŒæ­¥**ï¼š
   - æ¸…é™¤ç¼“å­˜ï¼š`app.openapi_schema = None`
   - FastAPI ä¼šåœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆæ–‡æ¡£

## ğŸ”¥ å½“å‰å®ç°çš„æ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šè·¯å¾„å‰ç¼€å†²çª
å½“å‰å®ç°ä¸­ï¼š
- ä¸»åº”ç”¨å·²ç»æœ‰ `/api` å‰ç¼€çš„è·¯ç”±ç³»ç»Ÿ
- æ’ä»¶è·¯ç”±ç›´æ¥æŒ‚è½½åˆ°ä¸»åº”ç”¨ï¼Œä½¿ç”¨ `/plugins/{plugin_key}` å‰ç¼€
- å¯èƒ½å­˜åœ¨è·¯ç”±åŒ¹é…ä¼˜å…ˆçº§é—®é¢˜

### é—®é¢˜2ï¼šè·¯ç”±é‡å¤æŒ‚è½½
æ—¥å¿—æ˜¾ç¤ºï¼š
```
07-10 17:38:38 [WARNING] æ’ä»¶è·¯ç”±åˆ·æ–°å¯èƒ½å¯¼è‡´è·¯ç”±é‡å¤ï¼Œå»ºè®®é‡å¯åº”ç”¨
æŒ‚è½½å‰ä¸»åº”ç”¨è·¯ç”±æ€»æ•°: 127
æŒ‚è½½åä¸»åº”ç”¨è·¯ç”±æ€»æ•°: 135 (å¢åŠ äº†8ä¸ªè·¯ç”±)
```
æ¯æ¬¡åˆ·æ–°éƒ½ä¼šå¢åŠ è·¯ç”±ï¼Œè¯´æ˜æ—§è·¯ç”±æ²¡æœ‰è¢«æ­£ç¡®ç§»é™¤ã€‚

### é—®é¢˜3ï¼šFastAPI è·¯ç”±åŒ¹é…æœºåˆ¶
FastAPI çš„è·¯ç”±åŒ¹é…æ˜¯æŒ‰ç…§**æ³¨å†Œé¡ºåº**è¿›è¡Œçš„ï¼š
- å¦‚æœå­˜åœ¨æ›´é€šç”¨çš„è·¯ç”±æ¨¡å¼åœ¨å‰é¢ï¼Œå¯èƒ½ä¼šæ‹¦æˆªæ’ä»¶è·¯ç”±çš„è¯·æ±‚
- éœ€è¦ç¡®ä¿æ’ä»¶è·¯ç”±çš„æ³¨å†Œé¡ºåºå’ŒåŒ¹é…ä¼˜å…ˆçº§

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ£€æŸ¥è·¯ç”±åŒ¹é…é¡ºåº
```python
# åœ¨è·¯ç”±ç®¡ç†å™¨ä¸­æ·»åŠ è°ƒè¯•åŠŸèƒ½
def debug_routes(self):
    if not self._app:
        return
    
    print("=== å½“å‰åº”ç”¨æ‰€æœ‰è·¯ç”± ===")
    for i, route in enumerate(self._app.router.routes):
        print(f"{i}: {route.path} - {type(route).__name__}")
        if hasattr(route, 'methods'):
            print(f"    Methods: {route.methods}")
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç‹¬ç«‹çš„å­åº”ç”¨
```python
# åˆ›å»ºç‹¬ç«‹çš„æ’ä»¶å­åº”ç”¨
plugins_app = FastAPI()

# å°†æ’ä»¶è·¯ç”±æŒ‚è½½åˆ°å­åº”ç”¨
plugins_app.include_router(plugin_router, prefix=f"/{plugin_key}")

# å°†å­åº”ç”¨æŒ‚è½½åˆ°ä¸»åº”ç”¨
main_app.mount("/plugins", plugins_app)
```

### æ–¹æ¡ˆ3ï¼šä¿®å¤è·¯å¾„åŒ¹é…
ç¡®ä¿æ’ä»¶è·¯ç”±è·¯å¾„ä¸ä¸ç°æœ‰è·¯ç”±å†²çªï¼š
```python
# å½“å‰ï¼š/plugins/{plugin_key}/{endpoint}
# å¯èƒ½å†²çªçš„è·¯ç”±ï¼š/{any_path} æˆ–å…¶ä»–é€šé…ç¬¦è·¯ç”±
```

## ğŸš€ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### æ­¥éª¤1ï¼šè°ƒè¯•å½“å‰è·¯ç”±çŠ¶æ€
```python
def debug_current_routes(app: FastAPI):
    print("=== è°ƒè¯•è·¯ç”±ä¿¡æ¯ ===")
    for i, route in enumerate(app.router.routes):
        if hasattr(route, 'path'):
            print(f"{i}: {route.path} - {type(route)}")
            if 'plugins' in route.path:
                print(f"    -> æ’ä»¶è·¯ç”±: {route.path}")
```

### æ­¥éª¤2ï¼šéªŒè¯è·¯ç”±æŒ‚è½½
```python
def verify_plugin_routes(app: FastAPI, plugin_key: str):
    target_prefix = f"/plugins/{plugin_key}"
    found_routes = []
    
    for route in app.router.routes:
        if hasattr(route, 'path') and route.path.startswith(target_prefix):
            found_routes.append(route.path)
    
    print(f"æ‰¾åˆ°æ’ä»¶ {plugin_key} çš„è·¯ç”±: {found_routes}")
    return found_routes
```

### æ­¥éª¤3ï¼šä¿®å¤è·¯ç”±å†²çª
å¦‚æœå‘ç°è·¯ç”±å†²çªï¼Œé‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š
1. è°ƒæ•´æ’ä»¶è·¯ç”±çš„æ³¨å†Œé¡ºåº
2. ä½¿ç”¨æ›´å…·ä½“çš„è·¯å¾„æ¨¡å¼
3. è€ƒè™‘ä½¿ç”¨å­åº”ç”¨éš”ç¦»

## ğŸ“‹ æµ‹è¯•éªŒè¯æ¸…å•

- [ ] æ£€æŸ¥ä¸»åº”ç”¨çš„æ‰€æœ‰è·¯ç”±åˆ—è¡¨
- [ ] éªŒè¯æ’ä»¶è·¯ç”±æ˜¯å¦æ­£ç¡®æ³¨å†Œ
- [ ] æµ‹è¯•è·¯ç”±åŒ¹é…ä¼˜å…ˆçº§
- [ ] ç¡®è®¤è·¯å¾„å‰ç¼€æ²¡æœ‰å†²çª
- [ ] éªŒè¯ HTTP æ–¹æ³•åŒ¹é…
- [ ] æ£€æŸ¥ä¸­é—´ä»¶å½±å“

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤ååº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… æ­£å¸¸è®¿é—®æ’ä»¶è·¯ç”±ï¼š`GET /plugins/nekro.router_example/health`
2. âœ… è·¯ç”±åœ¨ OpenAPI æ–‡æ¡£ä¸­æ­£ç¡®æ˜¾ç¤º
3. âœ… æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•ï¼ˆGET, POST, PUT, DELETE ç­‰ï¼‰
4. âœ… æ­£ç¡®å¤„ç†è·¯å¾„å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°
5. âœ… è¿”å›æ­£ç¡®çš„ JSON å“åº”

## ğŸ“ å…³é”®ç»éªŒæ€»ç»“

1. **FastAPI åŠ¨æ€è·¯ç”±çš„æ­£ç¡®æ–¹å¼**ï¼š
   - ä½¿ç”¨ `include_router` æŒ‚è½½ `APIRouter`
   - æ— æ³•åŠ¨æ€ç§»é™¤ï¼Œåªèƒ½é‡å¤æŒ‚è½½ï¼ˆä¼šå¯¼è‡´é‡å¤ï¼‰
   - å»ºè®®é‡å¯åº”ç”¨æ¥å®Œå…¨åˆ·æ–°è·¯ç”±

2. **è·¯ç”±åŒ¹é…åŸç†**ï¼š
   - æŒ‰æ³¨å†Œé¡ºåºåŒ¹é…
   - æ›´å…·ä½“çš„è·¯å¾„åº”è¯¥åœ¨æ›´é€šç”¨çš„è·¯å¾„ä¹‹å‰
   - æ³¨æ„é€šé…ç¬¦è·¯ç”±çš„å½±å“

3. **è°ƒè¯•æŠ€å·§**ï¼š
   - æ‰“å°æ‰€æœ‰æ³¨å†Œçš„è·¯ç”±
   - æ£€æŸ¥è·¯ç”±æ•°é‡å˜åŒ–
   - éªŒè¯è·¯å¾„å‰ç¼€å’ŒåŒ¹é…æ¨¡å¼

---

*æœ¬æ–‡æ¡£è®°å½•äº† Nekro Agent æ’ä»¶è·¯ç”±ç³»ç»Ÿå®ç°è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œä¸ºåç»­å¼€å‘å’Œç»´æŠ¤æä¾›å‚è€ƒã€‚* 